// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// User model for authentication and data isolation
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String?  // Hashed password for credentials auth
  image     String?
  bio       String?  // User bio for social features
  emailVerified DateTime? @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Authentication related fields
  passwordResetToken String?
  passwordResetExpires DateTime?
  
  // OAuth accounts
  oauthProvider    String?  // 'google' | 'github' | 'discord' | 'apple'
  oauthProviderId  String?
  
  // Last login tracking
  lastLoginAt      DateTime?
  loginCount       Int      @default(0)

  settings      UserSettings?
  books         Book[]
  ratings       Rating[]
  tags          Tag[]
  collections   Collection[]
  readingLogs   ReadingLog[]
  syncOperations SyncOperation[]
  
  // Social features
  followedBy    UserFollow[] @relation("Following")
  following     UserFollow[] @relation("Follower")
  challenges    ReadingChallenge[]
  challengeParticipations ChallengeParticipant[]
  activityLogs  ActivityLog[]

  @@index([email])
  @@index([oauthProvider, oauthProviderId])
}

// User preferences and settings
model UserSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme                String   @default("system") // 'light' | 'dark' | 'system'
  defaultFormat        String   @default("physical") // 'physical' | 'kindle' | 'kobo' | 'audible' | 'audiobook' | 'pdf' | 'other'
  ratingDisplay        String   @default("stars") // 'stars' | 'numbers'
  dateFormat           String   @default("MM/dd/yyyy")
  readingReminders     Boolean  @default(true)
  newRecommendations   Boolean  @default(true)
  weeklyDigest         Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// Main book entity
model Book {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title           String
  subtitle        String?
  authors         String[]
  isbn13          String?  @unique
  coverUrl        String?
  localCoverPath  String?
  description     String?
  publisher       String?
  publishedYear   Int?
  publishedDate   String?
  pageCount       Int?
  format          String   @default("physical") // BookFormat enum
  addedAt         DateTime @default(now())
  externalIds     Json?    // { openLibrary?: string, googleBooks?: string, oclcNumber?: string, lccn?: string, deweyDecimal?: string }
  lastSyncedAt    DateTime?
  needsSync       Boolean  @default(true)
  localOnly       Boolean  @default(false)
  
  // Metadata fields
  genre           String?
  language        String?
  averageRating   Float?
  ratingsCount    Int?
  categories      String[]
  subjects        String[]
  tags            String[]
  printType       String?
  dimensions      Json?    // { height?: string, width?: string, thickness?: string }
  weight          String?
  country         String?
  languageCode    String?
  previewLink     String?
  infoLink        String?
  canonicalVolumeLink String?
  webReaderLink   String?
  isEbook         Boolean?
  epubAvailable   Boolean?
  pdfAvailable    Boolean?
  textToSpeechPermission String?
  seriesName      String?
  seriesVolume    Int?
  edition         String?
  volume          String?
  saleability     String?
  listPrice       Json?    // { amount: number, currencyCode: string }
  contentVersion  String?
  maturityRating  String?
  allowAnonLogging Boolean?
  authorDetails   Json?    // Array of { name: string, bio?: string, born?: string, died?: string, photoUrl?: string }

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  ratings         Rating[]
  bookTags        BookTag[]
  collectionBooks CollectionBook[]
  readingLogs     ReadingLog[]

  @@index([userId])
  @@index([isbn13])
  @@index([format])
  @@index([addedAt])
  @@index([userId, addedAt])
}

// Book ratings and reviews
model Rating {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookId            String
  book              Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  stars             Float    // 0.5 to 5.0, increments of 0.5
  review            String?
  reviewCreatedAt   DateTime?
  containsSpoilers  Boolean  @default(false)
  updatedAt         DateTime @updatedAt

  createdAt         DateTime @default(now())

  @@unique([userId, bookId])
  @@index([bookId])
  @@index([stars])
}

// Tag definitions
model Tag {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  color     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookTags  BookTag[]

  @@unique([userId, name])
  @@index([userId])
}

// Many-to-many relationship between books and tags
model BookTag {
  id      String @id @default(cuid())
  bookId  String
  book    Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  tagId   String
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([bookId, tagId])
  @@index([bookId])
  @@index([tagId])
}

// Collection definitions
model Collection {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  coverImage  String?
  isSmart     Boolean  @default(false)
  isPublic    Boolean  @default(false)  // Public visibility for social features
  smartRules  Json?    // Array of { field: 'rating' | 'format' | 'tags' | 'status' | 'year', operator: 'equals' | 'notEquals' | 'greaterThan' | 'lessThan' | 'contains', value: string | number | string[] }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  books       CollectionBook[]
  shares      CollectionShare[]
  shareLinks  ShareLink[]

  @@unique([userId, name])
  @@index([userId])
  @@index([isSmart])
  @@index([isPublic])
}

// Many-to-many relationship between collections and books
model CollectionBook {
  id           String     @id @default(cuid())
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  bookId       String
  book         Book       @relation(fields: [bookId], references: [id], onDelete: Cascade)
  order        Int        @default(0)
  addedAt      DateTime   @default(now())

  @@unique([collectionId, bookId])
  @@index([collectionId])
  @@index([bookId])
}

// Reading status logs
model ReadingLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookId     String
  book       Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  status     String   // 'want_to_read' | 'currently_reading' | 'read' | 'dnf'
  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, bookId])
  @@index([bookId])
  @@index([status])
}

// Sync operation queue
model SyncOperation {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type               String   // 'create' | 'update' | 'delete'
  entity             String   // 'book' | 'rating' | 'tag' | 'collection' | 'readingLog'
  entityId           String
  data               Json
  timestamp          DateTime @default(now())
  synced             Boolean  @default(false)
  conflictResolution String?  // 'local' | 'server' | 'merge'

  createdAt          DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([entityId])
  @@index([synced])
  @@index([timestamp])
}

// Cover image metadata (actual images stored in file storage)
model CoverImage {
  id        String   @id @default(cuid())
  bookId    String?
  userId    String
  path      String   // Path to file in storage (S3, local filesystem, etc.)
  mimeType  String   @default("image/jpeg")
  size      Int?
  createdAt DateTime @default(now())
   
  @@index([bookId])
  @@index([userId])
}

// ============================================================================
// Social Features Models
// ============================================================================

// User follow relationships
model UserFollow {
  id          String   @id @default(cuid())
  followerId  String
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// Collection sharing with specific users
model CollectionShare {
  id                String     @id @default(cuid())
  collectionId      String
  collection        Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  sharedWithUserId  String
  permission        String     @default("view") // 'view' | 'edit'
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@unique([collectionId, sharedWithUserId])
  @@index([collectionId])
  @@index([sharedWithUserId])
}

// Public share links for collections
model ShareLink {
  id          String     @id @default(cuid())
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  token       String     @unique
  expiresAt   DateTime?
  maxViews    Int?
  viewCount   Int        @default(0)
  allowEdit   Boolean    @default(false)
  createdAt   DateTime   @default(now())

  @@index([collectionId])
  @@index([token])
}

// Reading challenges
model ReadingChallenge {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  targetBooks   Int
  currentBooks  Int      @default(0)
  startDate     DateTime
  endDate       DateTime
  isPublic      Boolean  @default(false)
  isCompleted   Boolean  @default(false)
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  participants  ChallengeParticipant[]

  @@index([userId])
  @@index([isPublic])
}

// Community challenge participants
model ChallengeParticipant {
  id          String          @id @default(cuid())
  challengeId String
  challenge   ReadingChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  booksRead   Int             @default(0)
  progress    Int             @default(0)
  lastUpdated DateTime        @default(now())

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
}

// Activity feed entries
model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String   // 'book.read', 'book.started', 'collection.created', 'challenge.completed', 'challenge.joined', etc.
  bookId    String?
  metadata  Json?    // Additional activity data
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
