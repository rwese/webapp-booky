# Production Monitoring Configuration
# File: backend/monitoring.yml

# Prometheus Alert Rules
groups:
  - name: booky-alerts
    interval: 30s
    rules:
      # High Error Rate Alert
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status_code=~"5.."}[5m])) 
          / sum(rate(http_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "High error rate detected"
          description: "Error rate exceeded 5% for 5 minutes"
          runbook_url: "https://booky.app/runbooks/high-error-rate"
          dashboard_url: "https://grafana.booky.app/d/booky-backend"

      # High Latency Alert
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High API latency detected"
          description: "P95 latency exceeded 1 second for 10 minutes"
          runbook_url: "https://booky.app/runbooks/high-latency"

      # High Memory Usage Alert
      - alert: HighMemoryUsage
        expr: |
          container_memory_working_set_bytes{container="backend"} 
          / container_spec_memory_limit_bytes{container="backend"} > 0.85
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage exceeded 85%"
          runbook_url: "https://booky.app/runbooks/high-memory"

      # Database Connection Alert
      - alert: DatabaseConnectionIssues
        expr: |
          pg_stat_activity_count > 100
        for: 5m
        labels:
          severity: warning
          team: database
        annotations:
          summary: "High database connection count"
          description: "Database connections exceeded 100"
          runbook_url: "https://booky.app/runbooks/database-connections"

      # Sync Failure Alert
      - alert: SyncFailures
        expr: |
          increase(sync_operations_total{status="failure"}[1h]) > 10
        for: 5m
        labels:
          severity: warning
          team: sync
        annotations:
          summary: "High number of sync failures"
          description: "More than 10 sync failures in the last hour"
          runbook_url: "https://booky.app/runbooks/sync-failures"

      # Authentication Failures Alert
      - alert: HighAuthFailures
        expr: |
          increase(auth_operations_total{status="failure"}[5m]) > 20
        for: 5m
        labels:
          severity: warning
          team: security
        annotations:
          summary: "High number of authentication failures"
          description: "More than 20 auth failures in 5 minutes"
          runbook_url: "https://booky.app/runbooks/auth-failures"

      # Rate Limit Alert
      - alert: RateLimitExceeded
        expr: |
          increase(rate_limit_exceeded_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Rate limits being exceeded frequently"
          description: "More than 100 rate limit events in 5 minutes"

      # File Upload Failures
      - alert: FileUploadFailures
        expr: |
          increase(file_uploads_total{status="failure"}[1h]) > 50
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High number of file upload failures"
          description: "More than 50 file upload failures in the last hour"

  - name: booky-recording-rules
    interval: 30s
    rules:
      # Recording rules for better performance
      - record: booky:http_requests:rate5m
        expr: sum(rate(http_requests_total[5m])) by (method, route, status_code)

      - record: booky:http_request_duration:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, route))

      - record: booky:error_rate:5m
        expr: sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (route) 
          / sum(rate(http_requests_total[5m])) by (route)

      - record: booky:sync_success_rate:5m
        expr: sum(rate(sync_operations_total{status="success"}[5m])) by (type)
          / sum(rate(sync_operations_total[5m])) by (type)

      - record: booky:auth_success_rate:5m
        expr: sum(rate(auth_operations_total{status="success"}[5m])) by (type)
          / sum(rate(auth_operations_total[5m])) by (type)

      - record: booky:storage_usage:bytes
        expr: sum(storage_usage) by (type)

      - record: booky:active_users:5m
        expr: sum(active_users)

# Sentry Configuration
# sentry:
#   dsn: https://your-sentry-dsn@sentry.io/project-id
#   environment: production
#   release: 1.0.0
#   traces_sample_rate: 0.1
#   profiles_sample_rate: 0.1

# Health Check Configuration
# health_checks:
#   - name: api-health
#     url: https://api.booky.app/api/health
#     interval: 30s
#     timeout: 5s
#     failure_threshold: 3
#     success_threshold: 1

# Uptime Check Configuration
# uptime_checks:
#   - name: api-uptime
#     url: https://api.booky.app/api/health
#     interval: 60s
#     timeout: 10s
#     regions:
#       - us-east-1
#       - us-west-2
#       - eu-west-1

# Log Alert Rules
# log_alerts:
#   - name: error-log-spike
#     pattern: ERROR
#     threshold: 100
#     interval: 5m
#     severity: warning
