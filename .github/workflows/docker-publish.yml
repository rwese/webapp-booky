name: Docker Publish

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'vite.config.ts'
      - 'docker/**'
      - '.github/workflows/docker-publish.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'vite.config.ts'
      - 'docker/**'
      - '.github/workflows/docker-publish.yml'
  release:
    types: [created]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  BACKEND_DIR: docker/backend-lite

jobs:
  # Build and test frontend
  frontend-build:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "Build failed: index.html not found"
            exit 1
          fi
          echo "Frontend build successful!"
          ls -lh dist/

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist/
          retention-days: 1

  # Build and push backend Docker image
  backend-push:
    name: Build & Push Backend
    runs-on: ubuntu-latest
    needs: frontend-build
    if: github.event_name == 'push' || github.event_name == 'release'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/backend
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value={{version}}
            type=raw,value={{major}}.{{minor}},enable=false

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: backend-lite
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

  # Build and push frontend Docker image
  frontend-push:
    name: Build & Push Frontend
    runs-on: ubuntu-latest
    needs: frontend-build
    if: github.event_name == 'push' || github.event_name == 'release'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create frontend Docker directory
        run: mkdir -p docker/frontend

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: docker/frontend

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/frontend
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value={{version}}
            type=raw,value={{major}}.{{minor}},enable=false

      - name: Build frontend Dockerfile
        run: |
          cat > docker/frontend/Dockerfile << 'EOF'
          FROM nginx:alpine
          
          # Copy custom nginx configuration
          COPY nginx.conf /etc/nginx/conf.d/default.conf
          
          # Copy built static files (artifact is extracted directly to current directory)
          COPY . /usr/share/nginx/html/
          
          # Expose port
          EXPOSE 80
          
          HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
            CMD wget --no-verbose --tries=1 --spider http://localhost/ || exit 1
          
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Create nginx configuration
        run: |
          cat > docker/frontend/nginx.conf << 'EOF'
          server {
              listen 80;
              server_name localhost;
              root /usr/share/nginx/html;
              index index.html;

              # Gzip compression
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_proxied expired no-cache no-store private auth;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;

              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;

              # Cache static assets
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }

              # SPA routing
              location / {
                  try_files $uri $uri/ /index.html;
              }

              # Health check endpoint
              location /health {
                  access_log off;
                  return 200 "OK";
                  add_header Content-Type text/plain;
              }
          }
          EOF

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: docker/frontend
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

  # Create release with version tags
  release-tagging:
    name: Create Release Tags
    runs-on: ubuntu-latest
    needs: [backend-push, frontend-push]
    if: github.event_name == 'release'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Create release comment
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.repos.createReleaseComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Docker Images Published\n\nThe following images have been pushed to GitHub Container Registry:\n\n- `ghcr.io/${{ github.repository }}/frontend:${{ steps.version.outputs.version }}`\n- `ghcr.io/${{ github.repository }}/backend:${{ steps.version.outputs.version }}`\n\n### Usage\n\n```yaml\nservices:\n  frontend:\n    image: ghcr.io/${{ github.repository }}/frontend:${{ steps.version.outputs.version }}\n  backend:\n    image: ghcr.io/${{ github.repository }}/backend:${{ steps.version.outputs.version }}\n```',
              release_id: ${{ github.event.release.id }}
            })

  # Notify on completion
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [backend-push, frontend-push]
    if: always()
    steps:
      - name: Send success notification
        if: needs.backend-push.result == 'success' && needs.frontend-push.result == 'success'
        run: |
          echo "Docker images published successfully!"
          echo "Frontend: ${{ env.REGISTRY }}/${{ github.repository }}/frontend:latest"
          echo "Backend: ${{ env.REGISTRY }}/${{ github.repository }}/backend:latest"

      - name: Send failure notification
        if: needs.backend-push.result == 'failure' || needs.frontend-push.result == 'failure'
        run: |
          echo "Docker build/push failed!"
          echo "Please check the workflow logs for details."
          exit 1
